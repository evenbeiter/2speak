<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icons/icon-32.png">
<link rel="apple-touch-icon" href="icons/icon.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Note</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
@font-face{font-family:"Microsoft JhengHei" !important;src:local("Microsoft JhengHei") !important;unicode-range:U+4E00-9FFF !important}
body {font-family:arial,'Microsoft JhengHei', sans-serif !important}

/* 上方操作區固定 */
#topBar {
  position: sticky;
  top: 0;
  z-index: 1030;
  background: white;
  padding-top: 1rem;
}

/* 表格表頭固定 */
/* #noteTable thead th {
  position: sticky;
  top: 0;
  background-color: #f8f9fa;
  z-index: 2;
} */

td[contenteditable="true"] {
  min-width: 150px;
  outline: none;
}
tr.active {
  background-color: #ffeeba !important;
}

#noteTable td:nth-child(1),#noteTable th:nth-child(1) {width:50%}
#noteTable td:nth-child(2),#noteTable th:nth-child(2) {width:35%;color:#4b7bf5;font-weight:bold}
#noteTable td:nth-child(3),#noteTable th:nth-child(3) {width:15%}

@media screen and (-webkit-min-device-pixel-ratio: 2) {
  #noteTable td, 
  #noteTable th {
      display: block;
      width: 100% !important;
  }

  #noteTable tr {
      margin-bottom: 1rem;
      border: 1px solid #dee2e6;
      display: block;
  }

  #noteTable td::before {
      content: attr(data-label); /* 在手機版顯示欄位標題 */
      font-weight: bold;
      display: block;
      margin-bottom: 0.25rem;
  }
}
</style>
</head>
<body class="p-4">

  <div class="container">
    <!-- 固定在最上方的區域 -->
      <!-- 輸入區 -->
      <div class="mb-2" id="inputArea">
        <textarea id="inputText" class="form-control" rows="6" placeholder="在此貼上文字..."></textarea>
        <button id="btnGenerate" class="btn btn-primary mt-2">轉換成表格</button>
      </div>

      <div id="topBar">
        <!-- 儲存功能 -->
        <div class="input-group mb-2" id="saveSection">
            <input type="text" id="filename" class="form-control" placeholder="輸入檔名 (yyyymmddxx)">
            <button id="btnSave" class="btn btn-success">儲存到 GitHub</button>
        </div>

        <!-- 載入功能 -->
        <div class="input-group mb-2">
            <input type="text" id="loadFilename" class="form-control" placeholder="輸入檔名 (yyyymmddxx)">
            <button id="btnLoad" class="btn btn-secondary">繼續編輯</button>
        </div>

        <!-- 操作列 -->
        <div class="mb-2" id="toolBox" style="display:none;">
            <button id="btnDelete" class="btn btn-danger btn-sm">刪除列</button>
            <button id="btnDuplicate" class="btn btn-warning btn-sm">複製列</button>
            <button id="btnMerge" class="btn btn-info btn-sm">與前列合併</button>
            <button id="btnClearName" class="btn btn-secondary btn-sm">清除講者名</button>
            <button id="btnToggleSelect" class="btn btn-secondary btn-sm">啟用多選</button>
            <button id="btnDeleteSelected" class="btn btn-danger btn-sm" style="display:none;">刪除選取</button>

        </div>
      </div>

    <!-- 編輯表格 -->
    <div class="mb-3" id="tableContainer" style="display:none;">

      <div class="table-responsive">
        <table id="noteTable" class="table table-bordered table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th>句子</th>
                <th>筆記</th>
                <th>註解</th>
            </tr>
            </thead>
            <tbody contenteditable="true"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const inputText = document.getElementById("inputText");
    const btnGenerate = document.getElementById("btnGenerate");
    const toolBox = document.getElementById("toolBox");
    const tableContainer = document.getElementById("tableContainer");
    const noteTable = document.getElementById("noteTable").querySelector("tbody");
    const btnDelete = document.getElementById("btnDelete");
    const btnDuplicate = document.getElementById("btnDuplicate");
    const btnMerge = document.getElementById("btnMerge");
    const btnClearName = document.getElementById("btnClearName");
    const btnToggleSelect = document.getElementById("btnToggleSelect");
    const btnDeleteSelected = document.getElementById("btnDeleteSelected");
    const btnSave = document.getElementById("btnSave");
    const filenameInput = document.getElementById("filename");
    const btnLoad = document.getElementById("btnLoad");
    const loadFilenameInput = document.getElementById("loadFilename");

    let activeRow = null;

    // 分句方法
    function splitSentences(text) {
      return text.match(/[^.!?。！？\n]+[.!?。！？]?/g) || [];
    }

    // 檢查若有標點符號且不被[]包裹 => 要插入列
    function addRow(str) {
      const hasPunc = /[.,!?;:'"\-()[\]{}]/.test(str);  // 是否有英文標點符號
      const wrapped = /^\[.*\]$/.test(str);             // 是否完整被 [] 包裹
      return hasPunc && !wrapped;
    }

    // 生成表格
    btnGenerate.addEventListener("click", () => {
      noteTable.innerHTML = "";
      const sentences = splitSentences(inputText.value.trim());
      sentences.forEach(s => {
        if (addRow(s)){
          const row = noteTable.insertRow();
          row.insertCell(0).outerHTML = `<td contenteditable="true" data-label="句子">${s.replace(/\b([A-Z\s]+): /g,'').trim()}</td>`;
          row.insertCell(1).outerHTML = `<td contenteditable="true" data-label="筆記"></td>`;
          row.insertCell(2).outerHTML = `<td contenteditable="true" data-label="註解"></td>`;
          // row.insertCell(0).innerText = s.trim();
          // row.insertCell(1).innerText = "";
          // row.insertCell(2).innerText = "";
          for (let cell of row.cells) cell.setAttribute("contenteditable", "true");
        }
      });
      inputArea.style.display = "none";
      toolBox.style.display = "block";
      tableContainer.style.display = "block";
      document.getElementById("saveSection").style.display = "flex";
    });

    // 點擊列時設定 activeRow
    noteTable.addEventListener("click", e => {
      if (e.target.closest("tr")) {
        [...noteTable.rows].forEach(r => r.classList.remove("active"));
        activeRow = e.target.closest("tr");
        activeRow.classList.add("active");
      }
    });

    // 刪除列
    btnDelete.addEventListener("click", () => {
      if (activeRow) {
        noteTable.removeChild(activeRow);
        activeRow = null;
      }
    });

    // 複製列
    btnDuplicate.addEventListener("click", () => {
      if (activeRow) {
        const newRow = noteTable.insertRow(activeRow.rowIndex);
        newRow.insertCell(0).outerHTML = `<td contenteditable="true" data-label="句子">${activeRow.cells[0].innerText}</td>`;
        newRow.insertCell(1).outerHTML = `<td contenteditable="true" data-label="筆記"></td>`;
        newRow.insertCell(2).outerHTML = `<td contenteditable="true" data-label="註解"></td>`;
        // newRow.insertCell(0).innerText = activeRow.cells[0].innerText;
        // newRow.insertCell(1).innerText = "";
        // newRow.insertCell(2).innerText = "";
        for (let cell of newRow.cells) cell.setAttribute("contenteditable", "true");
      }
    });

    // 合併列
    btnMerge.addEventListener("click", () => {
      if (activeRow && activeRow.previousElementSibling) {
        activeRow.previousElementSibling.cells[0].innerText += " " + activeRow.cells[0].innerText;
        noteTable.removeChild(activeRow);
        activeRow = null;
      }
    });

    // Enter鍵分裂列
    noteTable.addEventListener("keydown", e => {
    if (e.key === "Enter") {
        const sel = window.getSelection();
        const range = sel.getRangeAt(0);

        let container = range.startContainer;
        if (container.nodeType === Node.TEXT_NODE) {
        container = container.parentElement;
        }

        const cell = container.closest("td");
        if (!cell) return;

        const row = cell.closest("tr");

        // ✅ 只攔截第一欄 (句子)
        if (cell.cellIndex === 0) {
        e.preventDefault(); // 阻止換行

        const text = cell.innerText;
        const pos = range.startOffset;
        const before = text.slice(0, pos);
        const after = text.slice(pos);
        cell.innerText = before;

        const newRow = noteTable.insertRow(row.rowIndex);
        newRow.insertCell(0).outerHTML = `<td contenteditable="true" data-label="句子">${after}</td>`;
        newRow.insertCell(1).outerHTML = `<td contenteditable="true" data-label="筆記"></td>`;
        newRow.insertCell(2).outerHTML = `<td contenteditable="true" data-label="註解"></td>`;
        // newRow.insertCell(0).innerText = after;
        // newRow.insertCell(1).innerText = "";
        // newRow.insertCell(2).innerText = "";
        for (let c of newRow.cells) c.setAttribute("contenteditable", "true");

        // 把游標移到新列的第一欄
        const newCell = newRow.cells[0];
        const rangeNew = document.createRange();
        rangeNew.selectNodeContents(newCell);
        rangeNew.collapse(true);
        sel.removeAllRanges();
        sel.addRange(rangeNew);
        }
        // 如果是第二欄或第三欄 → 不處理，保留原本 Enter 換行行為
    }
    });


    // 清除講者名
    btnClearName.addEventListener("click", () => {
        const hh = document.querySelectorAll('[data-label="句子"]');
        for (let h of hh){
            h.innerText=h.innerText.replace(/\b([A-Z\s]+): /g,'');
        }
    });


    const backendURL = 'https://newsbeiter.onrender.com';

    // 儲存
    btnSave.addEventListener("click", async () => {
      const filename = filenameInput.value.trim()+'.txt';
      if (filename==='.txt') return alert("請輸入檔名");

      //const data = [];
      //[...noteTable.rows].forEach(row => {
      //  data.push({
      //    note: row.cells[1].innerText.trim(),
      //    category: row.cells[2].innerText.trim(),
      //    example: row.cells[0].innerText.trim()
      //  });
      //});

      //const textData = data.map(d => 
      //  `{note:${d.note}, category:${d.category}, example:${d.example}}`
      //).join("\n");

const textData = [...noteTable.rows].map(row => {
  const obj = {
    note: row.cells[1].innerText.trim(),
    category: row.cells[2].innerText.trim(),
    example: row.cells[0].innerText.trim()
  };
  return JSON.stringify(obj);
}).join("\n");
      
      const url=`${backendURL}/lesson/add`;
      await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ filename, content: textData })
      });

      alert("已儲存到雲端");
    });


    // 載入
    btnLoad.addEventListener("click", async () => {
      const filename = loadFilenameInput.value.trim()+'.txt';
      if (filename==='.txt') return alert("請輸入檔名");

      filenameInput.value=filename.replace('.txt','');

      const url=`${backendURL}/notes/read`;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({category:'2speak', path:filename})
      });

      if (!res.ok) throw new Error('無法讀取筆記');

      const str = await res.json();

      noteTable.innerHTML = "";
      for (let s of str){
        const h=JSON.parse(s);
        //const match = s.match(/\{note:(.*?), category:(.*?), example:(.*)\}/);
        //if (match) {
          const row = noteTable.insertRow();
          row.insertCell(0).outerHTML = `<td contenteditable="true" data-label="句子">${h.example}</td>`;
          row.insertCell(1).outerHTML = `<td contenteditable="true" data-label="筆記">${h.note}</td>`;
          row.insertCell(2).outerHTML = `<td contenteditable="true" data-label="註解">${h.category}</td>`;
        //   row.insertCell(0).innerText = match[3];
        //   row.insertCell(1).innerText = match[1];
        //   row.insertCell(2).innerText = match[2];
          for (let c of row.cells) c.setAttribute("contenteditable", "true");
        //}
      };

      inputArea.style.display = "none";
      toolBox.style.display = "block";
      tableContainer.style.display = "block";
      document.getElementById("saveSection").style.display = "flex";

    });



// 選取 & 批次刪除

let multiSelectEnabled = false;

btnToggleSelect.addEventListener("click", () => {
  multiSelectEnabled = !multiSelectEnabled;

  if (multiSelectEnabled) {
    btnToggleSelect.innerText = "停用多選";
    btnDeleteSelected.style.display = "inline-block";

    // 在每一列最前面加上 checkbox
    [...noteTable.rows].forEach(row => {
      if (!row.querySelector("input[type='checkbox']")) {
        const checkboxCell = row.insertCell(1);  // 在最前面插入一個欄位
        checkboxCell.innerHTML = `<input type="checkbox" class="row-selector">`;
      }
    });

    // 表頭也加一個空白 th
    const theadRow = document.querySelector("thead tr");
    if (theadRow && !theadRow.querySelector(".select-col")) {
      const th = document.createElement("th");
      th.classList.add("select-col");
      th.innerText = "選取";
      theadRow.insertBefore(th, theadRow.children[1]);
    }

  } else {
    btnToggleSelect.innerText = "啟用多選";
    btnDeleteSelected.style.display = "none";

    // 移除每列的 checkbox
    [...noteTable.rows].forEach(row => {
      if (row.cells[1].querySelector("input[type='checkbox']")) {
        row.deleteCell(1);
      }
    });

    // 移除表頭的「選取」
    const theadRow = document.querySelector("thead tr");
    if (theadRow && theadRow.querySelector(".select-col")) {
      theadRow.removeChild(theadRow.querySelector(".select-col"));
    }
  }
});

btnDeleteSelected.addEventListener("click", () => {
  const checkboxes = noteTable.querySelectorAll("tbody .row-selector:checked");
  if (checkboxes.length === 0) {
    alert("請先勾選要刪除的列！");
    return;
  }

  checkboxes.forEach(cb => {
    const row = cb.closest("tr");
    if (row) row.remove();
  });
});

  </script>
</body>
</html>
