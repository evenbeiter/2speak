<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>筆記編輯器</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    td[contenteditable="true"] {
      min-width: 150px;
      outline: none;
    }
    tr.active {
      background-color: #ffeeba !important;
    }

    /* 表格表頭固定 */
    #noteTable thead th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 2;
    }

    /* 上方操作區固定 */
    #topBar {
      position: sticky;
      top: 0;
      z-index: 1030;
      background: white;
      padding-top: 1rem;
    }

  </style>
</head>
<body class="p-4">

  <div class="container">
    <!-- 固定在最上方的區域 -->
    <div id="topBar">
      <!-- 輸入區 -->
      <div class="mb-3">
        <textarea id="inputText" class="form-control" rows="6" placeholder="在此貼上文字..."></textarea>
        <button id="btnGenerate" class="btn btn-primary mt-2">1. 轉換成表格</button>
      </div>

      <!-- 儲存功能 -->
      <div class="input-group mb-3" id="saveSection" style="display:none;">
        <input type="text" id="filename" class="form-control" placeholder="輸入檔名 (example.txt)">
        <button id="btnSave" class="btn btn-success">儲存到 GitHub</button>
      </div>

      <!-- 載入功能 -->
      <div class="input-group mb-3">
        <input type="text" id="loadFilename" class="form-control" placeholder="輸入檔名 (example.txt)">
        <button id="btnLoad" class="btn btn-secondary">繼續編輯</button>
      </div>
    </div>

    <!-- 編輯表格 -->
    <div class="mb-3" id="tableContainer" style="display:none;">
      <div class="mb-2">
        <button id="btnDelete" class="btn btn-danger btn-sm">2. 刪除列</button>
        <button id="btnDuplicate" class="btn btn-warning btn-sm">3. 複製列</button>
        <button id="btnMerge" class="btn btn-info btn-sm">4. 與前列合併</button>
      </div>
      <table id="noteTable" class="table table-bordered table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>句子</th>
            <th>筆記</th>
            <th>註解</th>
          </tr>
        </thead>
        <tbody contenteditable="true"></tbody>
      </table>
    </div>


    <!-- 儲存功能 -->
    <div class="input-group mb-3" id="saveSection" style="display:none;">
      <input type="text" id="filename" class="form-control" placeholder="輸入檔名 (example.txt)">
      <button id="btnSave" class="btn btn-success">儲存到 GitHub</button>
    </div>

    <!-- 載入功能 -->
    <div class="input-group mb-3">
      <input type="text" id="loadFilename" class="form-control" placeholder="輸入檔名 (example.txt)">
      <button id="btnLoad" class="btn btn-secondary">繼續編輯</button>
    </div>
  </div>

  <script>
    const inputText = document.getElementById("inputText");
    const btnGenerate = document.getElementById("btnGenerate");
    const tableContainer = document.getElementById("tableContainer");
    const noteTable = document.getElementById("noteTable").querySelector("tbody");
    const btnDelete = document.getElementById("btnDelete");
    const btnDuplicate = document.getElementById("btnDuplicate");
    const btnMerge = document.getElementById("btnMerge");
    const btnSave = document.getElementById("btnSave");
    const filenameInput = document.getElementById("filename");
    const btnLoad = document.getElementById("btnLoad");
    const loadFilenameInput = document.getElementById("loadFilename");

    let activeRow = null;

    // 分句方法
    function splitSentences(text) {
      return text.match(/[^.!?。！？\n]+[.!?。！？]?/g) || [];
    }

    // 生成表格
    btnGenerate.addEventListener("click", () => {
      noteTable.innerHTML = "";
      const sentences = splitSentences(inputText.value.trim());
      sentences.forEach(s => {
        const row = noteTable.insertRow();
        row.insertCell(0).innerText = s.trim();
        row.insertCell(1).innerText = "";
        row.insertCell(2).innerText = "";
        for (let cell of row.cells) cell.setAttribute("contenteditable", "true");
      });
      inputText.style.display = "none";
      tableContainer.style.display = "block";
      document.getElementById("saveSection").style.display = "flex";
    });

    // 點擊列時設定 activeRow
    noteTable.addEventListener("click", e => {
      if (e.target.closest("tr")) {
        [...noteTable.rows].forEach(r => r.classList.remove("active"));
        activeRow = e.target.closest("tr");
        activeRow.classList.add("active");
      }
    });

    // 刪除列
    btnDelete.addEventListener("click", () => {
      if (activeRow) {
        noteTable.removeChild(activeRow);
        activeRow = null;
      }
    });

    // 複製列
    btnDuplicate.addEventListener("click", () => {
      if (activeRow) {
        const newRow = noteTable.insertRow(activeRow.rowIndex + 1);
        newRow.insertCell(0).innerText = activeRow.cells[0].innerText;
        newRow.insertCell(1).innerText = "";
        newRow.insertCell(2).innerText = "";
        for (let cell of newRow.cells) cell.setAttribute("contenteditable", "true");
      }
    });

    // 合併列
    btnMerge.addEventListener("click", () => {
      if (activeRow && activeRow.previousElementSibling) {
        activeRow.previousElementSibling.cells[0].innerText += " " + activeRow.cells[0].innerText;
        noteTable.removeChild(activeRow);
        activeRow = null;
      }
    });

    // Enter鍵分裂列
    noteTable.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const sel = window.getSelection();
        const range = sel.getRangeAt(0);
        const cell = range.startContainer.closest("td");
        const row = cell.closest("tr");
        if (cell.cellIndex === 0) {
          const text = cell.innerText;
          const pos = range.startOffset;
          const before = text.slice(0, pos);
          const after = text.slice(pos);
          cell.innerText = before;
          const newRow = noteTable.insertRow(row.rowIndex + 1);
          newRow.insertCell(0).innerText = after;
          newRow.insertCell(1).innerText = "";
          newRow.insertCell(2).innerText = "";
          for (let c of newRow.cells) c.setAttribute("contenteditable", "true");
        }
      }
    });

    // 儲存
    btnSave.addEventListener("click", async () => {
      const filename = filenameInput.value.trim();
      if (!filename) return alert("請輸入檔名");

      const data = [];
      [...noteTable.rows].forEach(row => {
        data.push({
          note: row.cells[1].innerText.trim(),
          category: row.cells[2].innerText.trim(),
          example: row.cells[0].innerText.trim()
        });
      });

      const textData = data.map(d => 
        `{note:${d.note}, category:${d.category}, example:${d.example}}`
      ).join("\n");

      await fetch("http://localhost:3000/save", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ filename, content: textData })
      });

      alert("已儲存到 GitHub");
    });

    // 載入
    btnLoad.addEventListener("click", async () => {
      const filename = loadFilenameInput.value.trim();
      if (!filename) return alert("請輸入檔名");

      const res = await fetch("http://localhost:3000/load?filename=" + filename);
      const textData = await res.text();

      noteTable.innerHTML = "";
      textData.split("\n").forEach(line => {
        const match = line.match(/\{note:(.*?), category:(.*?), example:(.*)\}/);
        if (match) {
          const row = noteTable.insertRow();
          row.insertCell(0).innerText = match[3];
          row.insertCell(1).innerText = match[1];
          row.insertCell(2).innerText = match[2];
          for (let c of row.cells) c.setAttribute("contenteditable", "true");
        }
      });

      inputText.style.display = "none";
      tableContainer.style.display = "block";
      document.getElementById("saveSection").style.display = "flex";
    });
  </script>
</body>
</html>